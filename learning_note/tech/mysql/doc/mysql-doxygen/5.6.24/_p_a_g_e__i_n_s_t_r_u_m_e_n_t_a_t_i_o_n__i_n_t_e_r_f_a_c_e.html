<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PERFORMANCE SCHEMA: Performance schema: instrumentation interface page.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PERFORMANCE SCHEMA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Performance schema: instrumentation interface page. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>MySQL performance schema instrumentation interface.</p>
<h1><a class="anchor" id="INTRO"></a>
Introduction</h1>
<p>The instrumentation interface consist of two layers:</p><ul>
<li>a raw ABI (Application Binary Interface) layer, that exposes the primitive instrumentation functions exported by the performance schema instrumentation</li>
<li>an API (Application Programing Interface) layer, that provides many helpers for a developer instrumenting some code, to make the instrumentation as easy as possible.</li>
</ul>
<p>The ABI layer consists of: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="psi_8h.html">mysql/psi/psi.h</a>&quot;</span></div></div><!-- fragment --><p>The API layer consists of: </p><div class="fragment"><div class="line"><span class="preprocessor">#include &quot;mysql/psi/mutex_mutex.h&quot;</span></div><div class="line"><span class="preprocessor">#include &quot;mysql/psi/mutex_file.h&quot;</span></div></div><!-- fragment --><p>The first helper is for mutexes, rwlocks and conditions, the second for file io.</p>
<p>The API layer exposes C macros and typedefs which will expand:</p><ul>
<li>either to non-instrumented code, when compiled without the performance schema instrumentation</li>
<li>or to instrumented code, that will issue the raw calls to the ABI layer so that the implementation can collect data.</li>
</ul>
<p>Note that all the names introduced (for example, <code>mysql_mutex_lock</code>) do not collide with any other namespace. In particular, the macro <code>mysql_mutex_lock</code> is on purpose not named <code>pthread_mutex_lock</code>. This is to:</p><ul>
<li>avoid overloading <code>pthread_mutex_lock</code> with yet another macro, which is dangerous as it can affect user code and pollute the end-user namespace.</li>
<li>allow the developer instrumenting code to selectively instrument some code but not all.</li>
</ul>
<h1><a class="anchor" id="PRINCIPLES"></a>
Design principles</h1>
<p>The ABI part is designed as a facade, that exposes basic primitives. The expectation is that each primitive will be very stable over time, but the list will constantly grow when more instruments are supported. To support binary compatibility with plugins compiled with a different version of the instrumentation, the ABI itself is versioned (see <code><a class="el" href="struct_p_s_i__v1.html">PSI_v1</a></code>, <code><a class="el" href="struct_p_s_i__v2.html">PSI_v2</a></code>).</p>
<p>For a given instrumentation point in the API, the basic coding pattern used is:</p><ul>
<li>(a) notify the performance schema of the operation about to be performed.</li>
<li>(b) execute the instrumented code.</li>
<li>(c) notify the performance schema that the operation is completed.</li>
</ul>
<p>An opaque "locker" pointer is returned by (a), that is given to (c). This pointer helps the implementation to keep context, for performances.</p>
<p>The following code fragment is annotated to show how in detail this pattern in implemented, when the instrumentation is compiled in:</p>
<pre class="fragment">static inline int mysql_mutex_lock(
  mysql_mutex_t *that, myf flags, const char *src_file, uint src_line)
{
  int result;
  struct PSI_mutex_locker_state state;
  struct PSI_mutex_locker *locker= NULL;

  ............... (a)
  locker= PSI_server-&gt;start_mutex_wait(&amp;state, that-&gt;p_psi,
                                       PSI_MUTEX_LOCK, locker, src_file, src_line);

  ............... (b)
  result= pthread_mutex_lock(&amp;that-&gt;m_mutex);

  ............... (c)
  PSI_server-&gt;end_mutex_wait(locker, result);

  return result;
}
</pre><p>When the performance schema instrumentation is not compiled in, the code becomes simply a wrapper, expanded in line by the compiler:</p>
<pre class="fragment">static inline int mysql_mutex_lock(...)
{
  int result;

  ............... (b)
  result= pthread_mutex_lock(&amp;that-&gt;m_mutex);

  return result;
}
</pre> </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
