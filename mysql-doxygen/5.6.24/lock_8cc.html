<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>PERFORMANCE SCHEMA: sql/lock.cc File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">PERFORMANCE SCHEMA
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_5bd71961b401a432086d0fb290a87f3f.html">sql</a></li>  </ul>
</div>
</div><!-- top -->
<div class="header">
  <div class="summary">
<a href="#define-members">Macros</a> &#124;
<a href="#func-members">Functions</a> &#124;
<a href="#var-members">Variables</a>  </div>
  <div class="headertitle">
<div class="title">lock.cc File Reference</div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><code>#include &quot;<a class="el" href="sql__priv_8h_source.html">sql_priv.h</a>&quot;</code><br />
<code>#include &quot;<a class="el" href="debug__sync_8h_source.html">debug_sync.h</a>&quot;</code><br />
<code>#include &quot;unireg.h&quot;</code><br />
<code>#include &quot;lock.h&quot;</code><br />
<code>#include &quot;sql_base.h&quot;</code><br />
<code>#include &quot;sql_parse.h&quot;</code><br />
<code>#include &quot;sql_acl.h&quot;</code><br />
<code>#include &lt;hash.h&gt;</code><br />
<code>#include &lt;assert.h&gt;</code><br />
</div><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="define-members"></a>
Macros</h2></td></tr>
<tr class="memitem:ga65cffe586bef8fdfb5334d343c069df6"><td class="memItemLeft" align="right" valign="top">
#define&#160;</td><td class="memItemRight" valign="bottom"><b>GET_LOCK_UNLOCK</b>&#160;&#160;&#160;1</td></tr>
<tr class="separator:ga65cffe586bef8fdfb5334d343c069df6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1bef164e121fc9d85a6e19eae9625365"><td class="memItemLeft" align="right" valign="top">
#define&#160;</td><td class="memItemRight" valign="bottom"><b>GET_LOCK_STORE_LOCKS</b>&#160;&#160;&#160;2</td></tr>
<tr class="separator:ga1bef164e121fc9d85a6e19eae9625365"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ga9633a7f4dda9f6c4c741e43df84e24f3"><td class="memItemLeft" align="right" valign="top">static <a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga9633a7f4dda9f6c4c741e43df84e24f3">get_lock_data</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **table_ptr, uint count, uint <a class="el" href="handler0alter_8cc.html#a4069e5feb5d17fbac4d832518d169cdd">flags</a>)</td></tr>
<tr class="separator:ga9633a7f4dda9f6c4c741e43df84e24f3"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gadeee13e85dfc0f473985f24f862c633f"><td class="memItemLeft" align="right" valign="top">
static int&#160;</td><td class="memItemRight" valign="bottom"><b>lock_external</b> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>, uint count)</td></tr>
<tr class="separator:gadeee13e85dfc0f473985f24f862c633f"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2022104b54fa744b1e6276b24c76eb74"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga2022104b54fa744b1e6276b24c76eb74">unlock_external</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>, uint count)</td></tr>
<tr class="separator:ga2022104b54fa744b1e6276b24c76eb74"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaa6d04e38cbcf6f9f05f18134f7abfc81"><td class="memItemLeft" align="right" valign="top">
static void&#160;</td><td class="memItemRight" valign="bottom"><b>print_lock_error</b> (int <a class="el" href="row0merge_8cc.html#a35322fe0b818842195cfd235eec09293">error</a>, const char *)</td></tr>
<tr class="separator:gaa6d04e38cbcf6f9f05f18134f7abfc81"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga64e60435751e25ded112238f216bfd0c"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga64e60435751e25ded112238f216bfd0c">lock_tables_check</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **<a class="el" href="fts0fts_8cc.html#aa86c147940343159f5b38505b80bb233">tables</a>, uint count, uint <a class="el" href="handler0alter_8cc.html#a4069e5feb5d17fbac4d832518d169cdd">flags</a>)</td></tr>
<tr class="separator:ga64e60435751e25ded112238f216bfd0c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3cdefe9db62025f107be509007ba15d1"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga3cdefe9db62025f107be509007ba15d1">reset_lock_data</a> (<a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *sql_lock)</td></tr>
<tr class="separator:ga3cdefe9db62025f107be509007ba15d1"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9085310cb26b5f8574f517a7373f4740"><td class="memItemLeft" align="right" valign="top">static void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga9085310cb26b5f8574f517a7373f4740">reset_lock_data_and_free</a> (<a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> **mysql_lock)</td></tr>
<tr class="separator:ga9085310cb26b5f8574f517a7373f4740"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga3a5f18c7a05b36a6e93c1d8e33cece78"><td class="memItemLeft" align="right" valign="top"><a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga3a5f18c7a05b36a6e93c1d8e33cece78">mysql_lock_tables</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **<a class="el" href="fts0fts_8cc.html#aa86c147940343159f5b38505b80bb233">tables</a>, uint count, uint <a class="el" href="handler0alter_8cc.html#a4069e5feb5d17fbac4d832518d169cdd">flags</a>)</td></tr>
<tr class="separator:ga3a5f18c7a05b36a6e93c1d8e33cece78"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2bff80304c9d27f634976ac8fe60cd38"><td class="memItemLeft" align="right" valign="top">
void&#160;</td><td class="memItemRight" valign="bottom"><b>mysql_unlock_tables</b> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *sql_lock)</td></tr>
<tr class="separator:ga2bff80304c9d27f634976ac8fe60cd38"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gafad092ec9a399db99abd75b57a9ee679"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#gafad092ec9a399db99abd75b57a9ee679">mysql_unlock_some_tables</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> **<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>, uint count)</td></tr>
<tr class="separator:gafad092ec9a399db99abd75b57a9ee679"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga1e24a131cbe030c49d953669f804877d"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga1e24a131cbe030c49d953669f804877d">mysql_unlock_read_tables</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *sql_lock)</td></tr>
<tr class="separator:ga1e24a131cbe030c49d953669f804877d"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad40fe56766e1b54e2fed60814aec1e58"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#gad40fe56766e1b54e2fed60814aec1e58">mysql_lock_remove</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *locked, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> *<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>)</td></tr>
<tr class="separator:gad40fe56766e1b54e2fed60814aec1e58"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga07896e99c9c248c6441be5c13c484303"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga07896e99c9c248c6441be5c13c484303">mysql_lock_abort</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> *<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>, bool upgrade_lock)</td></tr>
<tr class="separator:ga07896e99c9c248c6441be5c13c484303"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga321511c56502643e5aecbe6ed3e43b58"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#ga321511c56502643e5aecbe6ed3e43b58">mysql_lock_abort_for_thread</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> *<a class="el" href="row0upd_8cc.html#ab172ed3d3d31ff02fc5f798fe7e1bfb8">table</a>)</td></tr>
<tr class="separator:ga321511c56502643e5aecbe6ed3e43b58"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gae8e0ecd1f7872040079f5319aacd93a2"><td class="memItemLeft" align="right" valign="top">
<a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *&#160;</td><td class="memItemRight" valign="bottom"><b>mysql_lock_merge</b> (<a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *<a class="el" href="row0merge_8cc.html#aaba8987b345486af51614561bddd051b">a</a>, <a class="el" href="structst__mysql__lock.html">MYSQL_LOCK</a> *<a class="el" href="row0merge_8cc.html#a40730b4776204efc5a07b947ce63f0b4">b</a>)</td></tr>
<tr class="separator:gae8e0ecd1f7872040079f5319aacd93a2"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gac67865dd0ef1b003fdee2182aba9a049"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#gac67865dd0ef1b003fdee2182aba9a049">lock_schema_name</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, const char *db)</td></tr>
<tr class="separator:gac67865dd0ef1b003fdee2182aba9a049"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gab03d9cc9ff9682e9f2a961685fd90cb3"><td class="memItemLeft" align="right" valign="top">bool&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group___locking.html#gab03d9cc9ff9682e9f2a961685fd90cb3">lock_object_name</a> (THD *<a class="el" href="row0quiesce_8cc.html#a75b6f5ba5a17ae9fb524f56a5eed51cb">thd</a>, <a class="el" href="class_m_d_l__key.html#a391ec4bd98fec6852a48f7856546ed3b">MDL_key::enum_mdl_namespace</a> mdl_type, const char *db, const char *<a class="el" href="srv0start_8cc.html#a03c6040f5fe625af9dc4a701925fbe65">name</a>)</td></tr>
<tr class="separator:gab03d9cc9ff9682e9f2a961685fd90cb3"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="var-members"></a>
Variables</h2></td></tr>
<tr class="memitem:gadb186a1125c10d63d0217bc321a4c95a"><td class="memItemLeft" align="right" valign="top">
<a class="el" href="structst__hash.html">HASH</a>&#160;</td><td class="memItemRight" valign="bottom"><b>open_cache</b></td></tr>
<tr class="separator:gadb186a1125c10d63d0217bc321a4c95a"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga9ec7eb7dbcce8449c3a6df36c3945b08"><td class="memItemLeft" align="right" valign="top">static int&#160;</td><td class="memItemRight" valign="bottom"><b>thr_lock_errno_to_mysql</b> []</td></tr>
<tr class="separator:ga9ec7eb7dbcce8449c3a6df36c3945b08"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Locking functions for mysql.</p>
<p>Because of the new concurrent inserts, we must first get external locks before getting internal locks. If we do it in the other order, the status information is not up to date when called from the lock handler.</p>
<p>GENERAL DESCRIPTION OF LOCKING</p>
<p>When not using LOCK TABLES:</p>
<ul>
<li>For each SQL statement <a class="el" href="group___locking.html#ga3a5f18c7a05b36a6e93c1d8e33cece78">mysql_lock_tables()</a> is called for all involved tables.<ul>
<li><a class="el" href="group___locking.html#ga3a5f18c7a05b36a6e93c1d8e33cece78">mysql_lock_tables()</a> will call table_handler-&gt;external_lock(thd,locktype) for each table. This is followed by a call to thr_multi_lock() for all tables.</li>
</ul>
</li>
<li>When statement is done, we call mysql_unlock_tables(). This will call thr_multi_unlock() followed by table_handler-&gt;external_lock(thd, F_UNLCK) for each table.</li>
<li>Note that mysql_unlock_tables() may be called several times as MySQL in some cases can free some tables earlier than others.</li>
<li>The above is true both for normal and temporary tables.</li>
<li>Temporary non transactional tables are never passed to thr_multi_lock() and we never call external_lock(thd, F_UNLOCK) on these.</li>
</ul>
<p>When using LOCK TABLES:</p>
<ul>
<li>LOCK <a class="el" href="struct_t_a_b_l_e.html">TABLE</a> will call <a class="el" href="group___locking.html#ga3a5f18c7a05b36a6e93c1d8e33cece78">mysql_lock_tables()</a> for all tables. <a class="el" href="group___locking.html#ga3a5f18c7a05b36a6e93c1d8e33cece78">mysql_lock_tables()</a> will call table_handler-&gt;external_lock(thd,locktype) for each table. This is followed by a call to thr_multi_lock() for all tables.</li>
<li><p class="startli">For each statement, we will call table_handler-&gt;start_stmt(THD) to inform the table handler that we are using the table.</p>
<p class="startli">The tables used can only be tables used in LOCK TABLES or a temporary table.</p>
</li>
<li>When statement is done, we will call ha_commit_stmt(thd);</li>
<li>When calling UNLOCK TABLES we call mysql_unlock_tables() for all tables used in LOCK TABLES</li>
</ul>
<p>If table_handler-&gt;external_lock(thd, locktype) fails, we call table_handler-&gt;external_lock(thd, F_UNLCK) for each table that was locked, excluding one that caused failure. That means handler must cleanup itself in case external_lock() fails.</p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000053">Todo:</a></b></dt><dd>Change to use my_malloc() ONLY when using LOCK TABLES command or when we are forced to use mysql_lock_merge. </dd></dl>
</div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.13
</small></address>
</body>
</html>
